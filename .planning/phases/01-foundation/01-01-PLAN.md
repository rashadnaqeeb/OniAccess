---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - OniAccess/OniAccess.csproj
  - OniAccess/mod_info.yaml
  - OniAccess/Mod.cs
  - OniAccess/Speech/SpeechEngine.cs
  - OniAccess/Util/LogHelper.cs
  - OniAccess/OniAccessStrings.cs
autonomous: true

must_haves:
  truths:
    - "Game launches with mod loaded and Tolk initializes without DllNotFoundException"
    - "User hears 'Oni-Access version X loaded' through their screen reader on game start"
    - "All mod log messages are prefixed with [OniAccess] for easy filtering"
    - "Mod strings are defined as LocString entries in the STRINGS namespace, not hardcoded English"
  artifacts:
    - path: "OniAccess/OniAccess.csproj"
      provides: "Build configuration targeting net472 with game DLL references"
      contains: "net472"
    - path: "OniAccess/mod_info.yaml"
      provides: "Mod metadata for ONI mod loader"
      contains: "APIVersion: 2"
    - path: "OniAccess/Mod.cs"
      provides: "UserMod2 entry point with Tolk init and startup speech"
      contains: "class Mod : KMod.UserMod2"
    - path: "OniAccess/Speech/SpeechEngine.cs"
      provides: "Tolk P/Invoke wrapper evolved from Speech.cs"
      contains: "Tolk_Output"
    - path: "OniAccess/OniAccessStrings.cs"
      provides: "Localized mod strings in STRINGS namespace"
      contains: "namespace STRINGS"
  key_links:
    - from: "OniAccess/Mod.cs"
      to: "OniAccess/Speech/SpeechEngine.cs"
      via: "SpeechEngine.Initialize() call in OnLoad"
      pattern: "SpeechEngine\\.Initialize"
    - from: "OniAccess/Mod.cs"
      to: "tolk/dist/Tolk.dll"
      via: "SetDllDirectory before Tolk_Load"
      pattern: "SetDllDirectory"
    - from: "OniAccess/OniAccessStrings.cs"
      to: "OniAccess/Mod.cs"
      via: "startup message uses STRINGS.ONIACCESS.SPEECH.MOD_LOADED"
      pattern: "ONIACCESS\\.SPEECH\\.MOD_LOADED"
---

<objective>
Create the project scaffolding, mod entry point, and Tolk speech engine for Oni-Access.

Purpose: Establish a buildable ONI mod that loads via KMod.UserMod2, initializes Tolk for screen reader output, and speaks a startup confirmation. This is the foundation everything else builds on.
Output: A compilable mod project with working speech output on game launch.
</objective>

<execution_context>
@C:/Users/rasha/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rasha/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
@Speech.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create project scaffolding and mod entry point</name>
  <files>
    OniAccess/OniAccess.csproj
    OniAccess/mod_info.yaml
    OniAccess/Mod.cs
    OniAccess/Util/LogHelper.cs
    OniAccess/OniAccessStrings.cs
  </files>
  <action>
Create the OniAccess project directory structure and core files:

**OniAccess/OniAccess.csproj:**
- Target `net472` (ONI's Mono runtime)
- Reference game DLLs via `$(ONI_MANAGED)` environment variable: `Assembly-CSharp.dll`, `Assembly-CSharp-firstpass.dll`, `0Harmony.dll`, `UnityEngine.dll`, `UnityEngine.CoreModule.dll`
- Reference `Unity.TextMeshPro.dll` for rich text tag knowledge
- Output type: Library
- Do NOT include Tolk DLLs as references -- they are loaded via P/Invoke at runtime
- Set `<CopyLocal>false</CopyLocal>` on all game DLL references
- Set assembly name to `OniAccess`

**OniAccess/mod_info.yaml:**
```yaml
supportedContent: ALL
minimumSupportedBuild: 707956
APIVersion: 2
version: "0.1.0"
```

**OniAccess/Mod.cs:**
- Namespace: `OniAccess`
- Class `Mod` extends `KMod.UserMod2` (sealed)
- Static properties: `Instance` (Mod), `ModDir` (string), `Version` (string)
- `[DllImport("kernel32.dll", SetLastError = true)] static extern bool SetDllDirectory(string lpPathName)` for Tolk DLL path setup
- `OnLoad(Harmony harmony)`:
  1. Set `Instance = this`, `ModDir = Path.GetDirectoryName(typeof(Mod).Assembly.Location)`
  2. Extract version from assembly: `typeof(Mod).Assembly.GetName().Version`
  3. Call `SetDllDirectory(Path.Combine(ModDir, "tolk", "dist"))` -- BEFORE any Tolk calls
  4. Call `base.OnLoad(harmony)` -- auto-discovers `[HarmonyPatch]` classes
  5. Call `SpeechEngine.Initialize()`
  6. Call `SpeechEngine.Say(string.Format(STRINGS.ONIACCESS.SPEECH.MOD_LOADED, Version), interrupt: true)`
- NOTE: The Tolk native DLLs live at project root `tolk/dist/`, NOT inside OniAccess/. The `ModDir` will resolve to the parent directory where the compiled DLL is deployed alongside `tolk/dist/`. During development, the built DLL and `tolk/dist/` must both end up in the mod's install directory.

**OniAccess/Util/LogHelper.cs:**
- Namespace: `OniAccess.Util`
- Static class `Log` with methods: `Info(string msg)`, `Warn(string msg)`, `Error(string msg)`
- All prefix with `[OniAccess]`: `Debug.Log($"[OniAccess] {msg}")`

**OniAccess/OniAccessStrings.cs:**
- Define mod strings as LocString fields in the STRINGS namespace for localization support
- Namespace path: `STRINGS.ONIACCESS.SPEECH` and `STRINGS.ONIACCESS.HOTKEYS`
- Per locked decision: use full localization with STRINGS entries for mod text
- Strings to define:
  - `SPEECH.MOD_LOADED` = `"Oni-Access version {0} loaded"` (with format placeholder for version)
  - `SPEECH.MOD_ON` = `"Oni-Access on"`
  - `SPEECH.MOD_OFF` = `"Oni-Access off"`
  - `HOTKEYS.TOGGLE_MOD` = `"Toggle Oni-Access on/off"`
  - `HOTKEYS.CONTEXT_HELP` = `"Show available commands"`
- Call `Localization.RegisterForTranslation(typeof(STRINGS.ONIACCESS))` during mod init to enable community translations
  </action>
  <verify>
- `dotnet build OniAccess/OniAccess.csproj` succeeds (or manual build verification if ONI_MANAGED is not set in CI -- note this in SUMMARY)
- Mod.cs compiles with no errors referencing SpeechEngine, LogHelper, and STRINGS.ONIACCESS
- mod_info.yaml has APIVersion: 2
- All mod-facing text uses STRINGS.ONIACCESS constants, not hardcoded strings
  </verify>
  <done>
Project builds targeting net472, Mod.cs calls SetDllDirectory then SpeechEngine.Initialize() then speaks startup message using localized STRINGS, LogHelper prefixes all messages with [OniAccess].
  </done>
</task>

<task type="auto">
  <name>Task 2: Evolve Speech.cs into SpeechEngine with proper lifecycle</name>
  <files>
    OniAccess/Speech/SpeechEngine.cs
  </files>
  <action>
Evolve the existing `Speech.cs` into `OniAccess/Speech/SpeechEngine.cs`. This is an evolution, not a rewrite -- preserve the working Tolk P/Invoke signatures, initialization logic, and basic Say/Stop methods.

**Key changes from Speech.cs:**
1. Change namespace from `UnityKeyNav` to `OniAccess.Speech`
2. Rename class from `Speech` to `SpeechEngine`
3. Change `LogPrefix` from hardcoded property to use `LogHelper`
4. REMOVE the text filtering methods (`FilterRichText`, `ConvertSpriteTags`, sprite map, regex patterns) -- these move to `TextFilter.cs` in Plan 02. For now, `Say()` passes text directly to Tolk without filtering. Plan 02 will insert the filter pipeline.
5. REMOVE the `RegisterSpriteText` method -- moves to `TextFilter.cs` in Plan 02
6. Keep all Tolk P/Invoke declarations exactly as they are (they work)
7. Keep `Initialize()`, `Shutdown()`, `Say()`, `Stop()`, `IsInitialized`, `IsAvailable`
8. Add `Tolk_Silence()` P/Invoke: `[DllImport("Tolk.dll", CallingConvention = CallingConvention.Cdecl)] private static extern bool Tolk_Silence()` -- for proper speech stop
9. Update `Stop()` to use `Tolk_Silence()` instead of outputting empty string
10. Add an internal `RecordCallback` action field that `SpeechCapture` (Plan 03) will hook into: `internal static Action<string> OnSpeechOutput;` -- called in `Say()` before `Tolk_Output` so test capture can intercept
11. Make `Say()` call `OnSpeechOutput?.Invoke(text)` before `Tolk_Output(text, interrupt)` -- the text passed to the callback should be the final text sent to Tolk (after filtering, once filtering is added in Plan 02)

**Preserve from Speech.cs:**
- All `[DllImport]` signatures for Tolk_Load, Tolk_Unload, Tolk_Output, Tolk_TrySAPI, Tolk_HasSpeech, Tolk_DetectScreenReader
- The `Initialize()` try/catch pattern with DllNotFoundException handling
- The `_initialized` / `_available` state tracking pattern
- The screen reader detection logging
  </action>
  <verify>
- SpeechEngine.cs compiles in the OniAccess namespace
- All 6 Tolk P/Invoke declarations present plus Tolk_Silence
- Say() method calls OnSpeechOutput before Tolk_Output
- No text filtering code remains (that moves to Plan 02)
- No references to UnityKeyNav namespace
  </verify>
  <done>
SpeechEngine.cs is a clean Tolk wrapper in OniAccess.Speech namespace with Initialize/Shutdown/Say/Stop lifecycle, OnSpeechOutput callback hook for test capture, and no text filtering (deferred to Plan 02 TextFilter).
  </done>
</task>

</tasks>

<verification>
1. Project structure exists: OniAccess/ directory with .csproj, mod_info.yaml, Mod.cs, Speech/SpeechEngine.cs, Util/LogHelper.cs, OniAccessStrings.cs
2. Build succeeds targeting net472 (or build is validated as correct if game DLLs unavailable)
3. Mod.cs OnLoad sequence: SetDllDirectory -> base.OnLoad -> SpeechEngine.Initialize -> speak startup message
4. Startup message uses STRINGS.ONIACCESS.SPEECH.MOD_LOADED format string, not hardcoded English
5. SpeechEngine has OnSpeechOutput callback hook for future test capture
6. No text filtering in SpeechEngine (clean separation -- filtering is Plan 02's concern)
</verification>

<success_criteria>
- Buildable ONI mod project with correct .csproj targeting net472
- mod_info.yaml declares APIVersion: 2 and supportedContent: ALL
- Mod.cs extends KMod.UserMod2, handles Tolk DLL path, initializes speech, speaks on load
- SpeechEngine wraps Tolk P/Invoke with proper lifecycle (init, say, stop, shutdown)
- All mod text defined as LocString in STRINGS.ONIACCESS namespace
- LogHelper provides [OniAccess]-prefixed logging
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
