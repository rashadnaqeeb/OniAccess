---
phase: 03-menu-navigation
plan: 04
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - OniAccess/Input/Handlers/DuplicantSelectHandler.cs
  - OniAccess/Input/Handlers/SaveLoadHandler.cs
  - OniAccess/Input/ContextDetector.cs
  - OniAccess/OniAccessStrings.cs
autonomous: true

must_haves:
  truths:
    - "User can Tab between the 3 duplicant slots and hear each candidate's name"
    - "User can navigate within a duplicant slot to hear attributes one at a time (Athletics 3, Cooking 0)"
    - "User can hear trait name, effect, and description together on navigation (Mole Hands, +2 Digging, Moves through tiles faster)"
    - "User can reroll a duplicant and hear the new name, interests, and traits"
    - "User can browse colony saves by colony name, cycle number, duplicant count, and date"
    - "User can select and load any save with Enter"
    - "Shift+I reads attribute description on duplicant screen"
  artifacts:
    - path: "OniAccess/Input/Handlers/DuplicantSelectHandler.cs"
      provides: "Duplicant selection at colony start and Printing Pod"
      contains: "class DuplicantSelectHandler"
    - path: "OniAccess/Input/Handlers/SaveLoadHandler.cs"
      provides: "Save/load screen navigation"
      contains: "class SaveLoadHandler"
  key_links:
    - from: "OniAccess/Input/Handlers/DuplicantSelectHandler.cs"
      to: "OniAccess/Input/BaseMenuHandler.cs"
      via: "inherits BaseMenuHandler, overrides tab navigation for dupe slots"
      pattern: "BaseMenuHandler"
    - from: "OniAccess/Input/Handlers/SaveLoadHandler.cs"
      to: "OniAccess/Input/BaseMenuHandler.cs"
      via: "inherits BaseMenuHandler for save list navigation"
      pattern: "BaseMenuHandler"
    - from: "OniAccess/Input/ContextDetector.cs"
      to: "OniAccess/Input/Handlers/DuplicantSelectHandler.cs"
      via: "registry maps MinionSelectScreen to DuplicantSelectHandler"
      pattern: "MinionSelectScreen.*DuplicantSelectHandler"
---

<objective>
Implement handlers for duplicant selection (new game + Printing Pod) and save/load screens. A blind user can pick starting duplicants and manage saves.

Purpose: Duplicant selection is the last step before entering the colony. Save/load enables game persistence. Both use complex widget hierarchies that need specialized discovery. Duplicant selection is the most complex handler in Phase 3 due to multi-slot tabbing, per-attribute navigation, and trait/interest reading.

Output: DuplicantSelectHandler, SaveLoadHandler, registered in ContextDetector.
</objective>

<execution_context>
@C:/Users/rasha/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rasha/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-menu-navigation/03-RESEARCH.md
@.planning/phases/03-menu-navigation/03-01-SUMMARY.md
@OniAccess/Input/BaseMenuHandler.cs
@OniAccess/Input/WidgetInfo.cs
@OniAccess/Input/IAccessHandler.cs
@OniAccess/Input/ContextDetector.cs
@OniAccess/OniAccessStrings.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: DuplicantSelectHandler for MinionSelectScreen</name>
  <files>
    OniAccess/Input/Handlers/DuplicantSelectHandler.cs
    OniAccess/OniAccessStrings.cs
  </files>
  <action>
**DuplicantSelectHandler.cs** -- Handler for MinionSelectScreen (initial colony start) and Printing Pod selection:

Inherits `BaseMenuHandler`.

**Core design:** This screen has 3 duplicant slots (CharacterContainer instances). Tab/Shift+Tab switches between slots. Within each slot, Up/Down navigates a flat list of: attributes, traits, interests, and action buttons (reroll, interest filter).

**State:**
- `private int _currentSlot = 0` -- which of the 3 dupe slots is active (0, 1, 2)
- `private CharacterContainer[] _containers` -- the 3 CharacterContainer components (per Pitfall 4: these are child components, NOT standalone screens)
- `DisplayName => STRINGS.ONIACCESS.HANDLERS.DUPLICANT_SELECT` ("Select duplicants")

**Tab navigation (override NavigateTabForward/Backward):**
- `NavigateTabForward()`: `_currentSlot = (_currentSlot + 1) % _containers.Length`. Rediscover widgets for new slot. Speak: dupe name via SpeakInterrupt, first widget via SpeakQueued.
- `NavigateTabBackward()`: same but decrement with wrap
- If wrapped, play wrap sound

**DiscoverWidgets(KScreen screen):**
1. Find CharacterContainer instances: `screen.GetComponentsInChildren<CharacterContainer>(true)`. Store in `_containers`. Per Pitfall 4, these call KScreen.Activate but are NOT pushed to KScreenManager -- ContextDetector ignores them because they're not registered.
2. Focus on `_containers[_currentSlot]`. Build widget list for this single slot:

For the current CharacterContainer, build items in this order:
a. **Name** (Label): Get `characterNameTitle` LocText or EditableTitleBar text via Traverse. Add as Label widget.
b. **Interests** (Label): Get the aptitude/interest text. These appear as LocText elements showing interest names (e.g., "Research, Cooking"). Add as one Label item: "Interests: Research, Cooking".
c. **Traits** (Labels, one per trait): Access the trait entries from the CharacterContainer. Per research Finding 6: traits are dynamically created LocText elements. Per locked decision: "Traits: full info upfront (name, effect, description)." For each trait widget, `GetWidgetSpeechText` MUST combine the LocText.text (which contains name + effect, e.g., "Mole Hands, +2 Digging") AND the ToolTip description text (e.g., "Moves through tiles faster") into a single composite label: "Mole Hands, +2 Digging, Moves through tiles faster". Build this composite during widget discovery by reading both sources and storing as the WidgetInfo.Label. If ToolTip text is too long, truncate to first sentence. Shift+I on a trait re-reads the same full info (no hidden detail).

d. **Attributes** (Labels, one per attribute): Access the attribute entries (`iconGroups` in CharacterContainer). Per research: dynamically created with LocText containing "+3 Athletics" style text. Per decision: "one per arrow press: 'Athletics 3'". Parse or just read the LocText.text directly. Shift+I reads the full attribute description from ToolTip.

e. **Interest filter** (Dropdown): Access `archetypeDropDown` via Traverse. Add as Dropdown WidgetInfo. Per decision: "Left/Right on filter to cycle."

f. **Reroll button** (Button): Access `reshuffleButton` KButton via Traverse. Add as Button WidgetInfo with label "Reroll".

**After reroll handling:**
Per decision: "After rerolling: speak new dupe name, interests, and traits. User navigates to read full attributes."
- Override `ActivateCurrentWidget`: when the Reroll button is clicked, after the click:
  1. Wait a frame for the CharacterContainer to update (the reroll callback populates new data)
  2. Rediscover widgets for the current slot
  3. Speak: new dupe name, interests, and traits via SpeakInterrupt/SpeakQueued chain
  4. Set _currentIndex to 0 (back to name)

  Implementation: After `SignalClick`, start a coroutine or schedule a one-frame delay. Since we can't easily do coroutines from non-MonoBehaviour, use a flag checked on next HandleUnboundKey or simply call DiscoverWidgets and speak immediately after SignalClick -- the data may already be updated synchronously. Test in-game. If not synchronous, add a `_pendingRerollAnnounce = true` flag checked in `HandleUnboundKey`.

**Printing Pod variation:**
Per decision: "Printing Pod selection: same duplicant reading approach as initial selection, but no rerolling." If `_screen` is a Printing Pod variant (check if there are 3 candidate slots plus care package options), the Reroll button may not exist. Simply skip adding it during widget discovery if `reshuffleButton` is null or not active. Care package options should be added as additional items if present.

**HelpEntries:**
- Tab/Shift+Tab: switch between duplicant slots
- Up/Down: navigate attributes, traits, and controls
- Left/Right: cycle interest filter
- Enter: reroll / activate
- Shift+I: read attribute/trait description
- Home/End: jump to first/last item
- F12: help

**OniAccessStrings.cs** -- Add:
```
HANDLERS.DUPLICANT_SELECT = "Select duplicants"
```
  </action>
  <verify>
Build: `dotnet build OniAccess/OniAccess.csproj -c Release` must succeed.
  </verify>
  <done>
DuplicantSelectHandler navigates 3 duplicant slots via Tab, reads attributes one per arrow press, reads traits with full info upfront (name + effect + description), supports reroll with automatic re-announcement, and handles interest filter dropdown. Shift+I reads extended descriptions.
  </done>
</task>

<task type="auto">
  <name>Task 2: SaveLoadHandler and ContextDetector registration</name>
  <files>
    OniAccess/Input/Handlers/SaveLoadHandler.cs
    OniAccess/Input/ContextDetector.cs
    OniAccess/OniAccessStrings.cs
  </files>
  <action>
**SaveLoadHandler.cs** -- Handler for LoadScreen:

Inherits `BaseMenuHandler`.

**Two-level navigation:**
Per research Finding 7, LoadScreen has two views:
1. Colony list (colonyListRoot): list of colonies with headers
2. Colony save view (colonyViewRoot): individual saves for a selected colony

Track current view via `private bool _inColonySaveView = false`.

**DisplayName**: "Save and load" (add LocString)

**DiscoverWidgets(KScreen screen):**

If `_inColonySaveView == false` (colony list):
1. Access `colonyListRoot` Transform via Traverse
2. Find colony entries: each is a HierarchyReferences entry with HeaderTitle, HeaderDate, SaveTitle children
3. For each colony entry:
   - Get colony name from HeaderTitle LocText
   - Get date from HeaderDate LocText
   - Get save info from SaveTitle LocText (contains cycle count and other info)
   - Build composite label per decision: "colony name, cycle N, X duplicants, date". Parse cycle and duplicant count from the save info text.
   - Add as Button WidgetInfo (clicking expands to show individual saves)
   - The Component is the KButton on the colony entry

If `_inColonySaveView == true` (individual saves):
1. Access `colonyViewRoot` Transform via Traverse
2. Find save entries: each has SaveText, DateText, AutoLabel, NewestLabel, LoadButton
3. For each save entry:
   - Get save name from SaveText LocText
   - Get date from DateText LocText
   - Check if auto-save: AutoLabel active?
   - Check if newest: NewestLabel active?
   - Build label: "save_name, date" with "auto-save" or "newest" prefix if applicable. Per decision: "read colony name, cycle number, duplicant count, and date per entry. File size omitted."
   - Add as Button WidgetInfo. Component is the LoadButton KButton.

**Handling view transitions:**
- When Enter is pressed on a colony in the colony list view: the game expands to show individual saves. Override `ActivateCurrentWidget` to:
  1. Click the colony entry button (SignalClick)
  2. Verify transition completed: check `Traverse.Create(_screen).Field("colonyViewRoot").GetValue<UnityEngine.GameObject>()?.activeSelf == true` before proceeding. If colonyViewRoot is not yet active (async UI update), set a `_pendingViewTransition = true` flag and check in the next HandleUnboundKey or Tick call (if ITickable, check on next frame). Once colonyViewRoot is confirmed active, proceed to step 3.
  3. Set `_inColonySaveView = true`
  4. Rediscover widgets (now shows individual saves)
  5. Speak: colony name then first save entry

- When Escape is pressed in colony save view: go back to colony list. Override HandleKeyDown for Escape:
  1. If `_inColonySaveView`, set `_inColonySaveView = false`
  2. Click the back button or trigger the game's back navigation
  3. Rediscover widgets (now shows colony list)
  4. Speak: "Save and load" then first colony
  5. Consume the Escape event (don't let it close the screen)
  6. Return true

- When Enter is pressed on a save in the save view: load the save. Click the LoadButton.

**HelpEntries:**
- Up/Down: navigate saves/colonies
- Enter: expand colony / load save
- Escape: back to colony list (from save view) or close (from colony list -- let game handle)
- Home/End: jump to first/last
- F12: help
- A-Z: type-ahead search

**ContextDetector.cs** -- Add registrations:
- `Register(typeof(MinionSelectScreen))` -> `screen => new Handlers.DuplicantSelectHandler(screen)`
- `Register(typeof(LoadScreen))` -> `screen => new Handlers.SaveLoadHandler(screen)`

Note: For the Printing Pod variant, it may use the same MinionSelectScreen or a different screen class. If it uses CharacterSelectionController subclass, register that too. Research indicates MinionSelectScreen inherits CharacterSelectionController -- the same handler should work for both initial selection and Printing Pod if they use the same screen class.

**OniAccessStrings.cs** -- Add:
```
HANDLERS.SAVE_LOAD = "Save and load"
```
  </action>
  <verify>
Build: `dotnet build OniAccess/OniAccess.csproj -c Release` must succeed. Verify SaveLoadHandler has two-level navigation. Verify ContextDetector has registrations for MinionSelectScreen and LoadScreen.
  </verify>
  <done>
SaveLoadHandler navigates colony list and individual save entries with two-level drill-down. Save entries speak colony name, cycle, duplicant count, and date (no file size). DuplicantSelectHandler and SaveLoadHandler are registered in ContextDetector. All Phase 3 screen handlers are now complete.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build OniAccess/OniAccess.csproj -c Release` -- clean build
2. DuplicantSelectHandler has Tab/Shift+Tab for 3 dupe slots
3. DuplicantSelectHandler reads attributes one per arrow (not all at once)
4. DuplicantSelectHandler reads traits with full info upfront (name + effect + description)
5. DuplicantSelectHandler supports Reroll with re-announcement
6. SaveLoadHandler has colony list view and colony save view with drill-down
7. SaveLoadHandler speaks colony name, cycle, dupes, date -- not file size
8. Both handlers registered in ContextDetector
9. All Phase 3 ContextDetector registrations complete: MainMenu, PauseScreen, ConfirmDialogScreen, OptionsMenuScreen, AudioOptionsScreen, GraphicsOptionsScreen, GameOptionsScreen, ClusterCategorySelectionScreen, ColonyDestinationSelectScreen, WorldGenScreen, MinionSelectScreen, LoadScreen
</verification>

<success_criteria>
- Full new game flow is navigable: Main Menu -> New Game -> Game Mode -> Asteroid Selection -> Duplicant Selection -> World Gen -> Colony
- Save/load screen accessible with two-level hierarchy
- All locked decisions for speech feedback honored (label+value only, no type, traits with full info, attributes one at a time)
- Shift+I works for tooltip/hover info across all screens
- Type-ahead search works in all list-based screens
- Project builds clean
</success_criteria>

<output>
After completion, create `.planning/phases/03-menu-navigation/03-04-SUMMARY.md`
</output>
