---
phase: 03-menu-navigation
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - OniAccess/Input/Handlers/ColonySetupHandler.cs
  - OniAccess/Input/Handlers/WorldGenHandler.cs
  - OniAccess/Input/ITickable.cs
  - OniAccess/Input/KeyPoller.cs
  - OniAccess/Input/ContextDetector.cs
  - OniAccess/OniAccessStrings.cs
autonomous: true

must_haves:
  truths:
    - "User can hear game mode names and descriptions and select one (Survival, No Sweat, etc.)"
    - "User can browse asteroid clusters with name, difficulty, and world traits read aloud"
    - "User can Tab between panels (cluster list, world seed, game settings) on the asteroid selection screen"
    - "User can adjust game settings (disease, hunger, morale, stress) with Left/Right to cycle difficulty levels"
    - "User hears periodic progress updates during world generation (25%, 50%, 75%, Done)"
    - "World generation handler automatically activates when WorldGenScreen opens and deactivates when it closes"
  artifacts:
    - path: "OniAccess/Input/Handlers/ColonySetupHandler.cs"
      provides: "Colony setup flow: game mode selection and asteroid/settings configuration"
      contains: "class ColonySetupHandler"
    - path: "OniAccess/Input/Handlers/WorldGenHandler.cs"
      provides: "World generation progress announcements"
      contains: "class WorldGenHandler"
  key_links:
    - from: "OniAccess/Input/Handlers/ColonySetupHandler.cs"
      to: "OniAccess/Input/BaseMenuHandler.cs"
      via: "inherits BaseMenuHandler, overrides Tab for panel switching on ColonyDestinationSelectScreen"
      pattern: "BaseMenuHandler"
    - from: "OniAccess/Input/Handlers/WorldGenHandler.cs"
      to: "OniAccess/Input/IAccessHandler.cs"
      via: "implements IAccessHandler directly (not BaseMenuHandler -- no widgets to navigate)"
      pattern: "IAccessHandler"
    - from: "OniAccess/Input/ContextDetector.cs"
      to: "OniAccess/Input/Handlers/ColonySetupHandler.cs"
      via: "registry maps both ClusterCategorySelectionScreen and ColonyDestinationSelectScreen to ColonySetupHandler"
      pattern: "ColonyDestinationSelectScreen|ClusterCategorySelectionScreen"
---

<objective>
Implement handlers for the new game flow screens: game mode selection, asteroid/cluster selection with settings tabs, and world generation progress. A blind user can configure and start a new colony.

Purpose: After clicking "New Game" from the main menu, the user enters a multi-screen flow. ColonySetupHandler serves both the game mode screen (simple toggle list) and the colony destination screen (tabbed panels). Both are "new game setup" with the same semantics -- behavioral differences flow from which widgets are present. WorldGenHandler is separate because it has no widgets at all.

Output: ColonySetupHandler, WorldGenHandler, ITickable interface, registered in ContextDetector.
</objective>

<execution_context>
@C:/Users/rasha/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rasha/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-menu-navigation/03-RESEARCH.md
@.planning/phases/03-menu-navigation/03-01-SUMMARY.md
@OniAccess/Input/ScreenHandler.cs
@OniAccess/Input/BaseMenuHandler.cs
@OniAccess/Input/WidgetInfo.cs
@OniAccess/Input/IAccessHandler.cs
@OniAccess/Input/ContextDetector.cs
@OniAccess/Input/Handlers/MainMenuHandler.cs
@OniAccess/Input/Handlers/OptionsMenuHandler.cs
@OniAccess/OniAccessStrings.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: ColonySetupHandler for game mode and asteroid selection</name>
  <files>
    OniAccess/Input/Handlers/ColonySetupHandler.cs
    OniAccess/OniAccessStrings.cs
  </files>
  <action>
**ColonySetupHandler.cs** -- Handler for ClusterCategorySelectionScreen and ColonyDestinationSelectScreen:

Inherits `BaseMenuHandler`. This handler serves both screens in the new game setup flow. Determine which screen is active from `_screen.GetType()` and adapt widget discovery accordingly. The screens share semantics (new game configuration) -- behavioral differences flow from which widgets are present, not from fundamentally different navigation.

**DisplayName:** Check `_screen` type. Return `STRINGS.ONIACCESS.HANDLERS.GAME_MODE` ("Game mode") for ClusterCategorySelectionScreen, `STRINGS.ONIACCESS.HANDLERS.COLONY_DESTINATION` ("Colony destination") for ColonyDestinationSelectScreen.

**State (for ColonyDestinationSelectScreen only):**
- `private int _currentPanel` (0=clusters, 1=settings, 2=seed)

**Tab navigation (override NavigateTabForward/Backward):**
Only meaningful for ColonyDestinationSelectScreen. For ClusterCategorySelectionScreen, the base no-op stubs are fine.
- Cycle between 3 logical panels:
  1. **Cluster list panel** (index 0): cluster/asteroid selection
  2. **Settings panel** (index 1): game settings (NewGameSettingsPanel)
  3. **Seed panel** (index 2): world seed input
- `NavigateTabForward()`: if not ColonyDestinationSelectScreen, return. `_currentPanel = (_currentPanel + 1) % 3`. If wrapped, play wrap sound. Rediscover widgets for that panel. Speak panel name via SpeakInterrupt, first widget via SpeakQueued.
- `NavigateTabBackward()`: same with decrement and wrap.

**DiscoverWidgets(KScreen screen):**

**For ClusterCategorySelectionScreen (game mode select):**
- Find `MultiToggle[]` buttons for game modes (Survival, No Sweat, Custom) via `screen.GetComponentsInChildren<MultiToggle>(true)`
- For each MultiToggle, find the associated LocText children containing the mode name and description
- Per decision: "name and short description read together since description is visually present." Build composite label: "Survival, full gameplay with all challenges"
- Add each as Button WidgetInfo (MultiToggle clicked via Enter)

**For ColonyDestinationSelectScreen (asteroid selection + settings):**
Dispatch on `_currentPanel`:

Panel 0 (Cluster list):
- Access `clusterCategories` or the list of cluster options via Traverse. Each entry represents a cluster/asteroid.
- Per decision: "Cluster list entries: name, difficulty, AND world traits all read on navigation. Full info upfront."
- For each cluster entry, build a Label WidgetInfo whose Label is the full composite text: "Terra, Standard difficulty, Warm, Frozen Core" (name, difficulty, traits joined)
- Get traits from cluster data -- research shows `ColonyDestinationSelectScreen` has `destinationMapPanel` with cluster data. The exact data access needs runtime testing; use Traverse to access the cluster list and each cluster's name/difficulty/traits.
- `ActivateWidget` on a cluster entry: select that cluster (call the selection method or click the corresponding UI element)

Panel 1 (Settings):
- Access `NewGameSettingsPanel` from the screen. Per research: it contains `CustomGameSettingListWidget` entries.
- Each setting has a label and a current value. Add as Dropdown WidgetInfo.
- Per decision: "Each setting on one line: 'Disease, Default'. Left/Right cycles difficulty levels."
- Override `CycleDropdown`: call the setting widget's cycle method (e.g., `CycleQualitySetting(direction)` or the equivalent API)
- GetWidgetSpeechText for Dropdown: "Disease, Default"

Panel 2 (Seed):
- Find the seed input field (KInputTextField or InputField)
- Add as TextInput WidgetInfo
- Per decision: text input fields handled with Enter to activate, type content, Enter to confirm, Escape to cancel (with pre-edit value cached). Implement text input handling: override `ActivateCurrentWidget` for TextInput type to start edit mode, override `HandleKeyDown` to detect when in text edit mode (pass keys through to the input field), detect Enter to confirm and Escape to cancel.

**override ActivateCurrentWidget():**
- For game mode screen: get the MultiToggle from `widget.Component`, call `MultiToggle.Click()`. This selects the game mode and may auto-advance to the next screen.
- For other widget types: call `base.ActivateCurrentWidget()`

**HelpEntries:** Compose `CommonHelpEntries + ListNavHelpEntries` from ScreenHandler, plus screen-specific:
- `new HelpEntry("Tab/Shift+Tab", STRINGS.ONIACCESS.HELP.SWITCH_PANEL)` (add LocString)

**OniAccessStrings.cs** -- Add:
```
HANDLERS.GAME_MODE = "Game mode"
HANDLERS.COLONY_DESTINATION = "Colony destination"
PANELS.CLUSTERS = "Clusters"
PANELS.SETTINGS = "Settings"
PANELS.SEED = "World seed"
HELP.SWITCH_PANEL = "Switch panel"
```
  </action>
  <verify>
Build: `dotnet build OniAccess/OniAccess.csproj -c Release` must succeed.
  </verify>
  <done>
ColonySetupHandler serves both game mode selection (name + description spoken together) and colony destination screen with tabbed panels (cluster list with traits, settings with Left/Right cycling, seed input). Tab/Shift+Tab switches between panels on the destination screen; no-op on the mode screen.
  </done>
</task>

<task type="auto">
  <name>Task 2: WorldGenHandler, ITickable, and ContextDetector registration</name>
  <files>
    OniAccess/Input/Handlers/WorldGenHandler.cs
    OniAccess/Input/ITickable.cs
    OniAccess/Input/KeyPoller.cs
    OniAccess/Input/ContextDetector.cs
    OniAccess/OniAccessStrings.cs
  </files>
  <action>
**WorldGenHandler.cs** -- Special handler for world generation progress (NOT a BaseMenuHandler subclass):
- Implements `IAccessHandler` directly. Per Pitfall 6: WorldGenScreen has no interactive widgets. It's a progress display.
- `DisplayName => STRINGS.ONIACCESS.HANDLERS.WORLD_GEN` ("Generating world")
- `CapturesAllInput => true` -- block all input during generation (game blocks Escape too)
- `HelpEntries`: empty list or minimal ("World is generating, please wait")
- Private state: `float _lastSpokenPercent = -1f`, `float _lastPollTime`, `float _pollInterval = 2f` (seconds between checks)
- `OnActivate()`: speak "Generating world" via SpeakInterrupt. Set `_lastSpokenPercent = 0; _lastPollTime = UnityEngine.Time.time`

**ITickable.cs** -- Create `OniAccess/Input/ITickable.cs`:
```csharp
namespace OniAccess.Input
{
    /// <summary>
    /// Optional interface for handlers that need per-frame updates.
    /// KeyPoller checks for this on the active handler and calls Tick() each frame.
    /// Used by WorldGenHandler for progress polling.
    /// </summary>
    public interface ITickable
    {
        void Tick();
    }
}
```

**WorldGenHandler.Tick():**
1. Check `UnityEngine.Time.time - _lastPollTime < _pollInterval`. If too soon, return.
2. Set `_lastPollTime = UnityEngine.Time.time`
3. Find the percent text: use `Traverse.Create(_screen).Field("percentText").GetValue<LocText>()?.text`. Parse the percent from the text string. Alternative: `Traverse.Create(_screen).Field("offlineWorldGen").Field("currentPercent").GetValue<float>()`
4. Round to integer percent. If >= lastSpokenPercent + 25, speak: "{rounded} percent" via SpeakInterrupt. Update _lastSpokenPercent. Per discretion: speak at 25% intervals.
5. If percent >= 100 (or 1.0f): speak "World generation complete"
- `HandleKeyDown`, `HandleKeyUp`, `HandleUnboundKey`: return false for everything (no interaction during world gen)
- `OnDeactivate()`: no-op

**KeyPoller.cs** modification:
- In Update(), after the VanillaMode check, add:
  ```
  // Tick handlers that need per-frame updates (e.g., WorldGenHandler progress)
  var active = HandlerStack.ActiveHandler;
  if (active is ITickable tickable)
      tickable.Tick();
  ```
- Place this BEFORE the key polling loop

**ContextDetector.cs** -- Add registrations for new game flow screens:
- `Register` with `AccessTools.TypeByName("ClusterCategorySelectionScreen")` -> `screen => new Handlers.ColonySetupHandler(screen)` (if type exists; may be DLC-only. Check with null: if type is null, skip registration)
- `Register(typeof(ColonyDestinationSelectScreen))` -> `screen => new Handlers.ColonySetupHandler(screen)`
- `Register` with `AccessTools.TypeByName("WorldGenScreen")` -> `screen => new Handlers.WorldGenHandler(screen)`

**OniAccessStrings.cs** -- Add:
```
HANDLERS.WORLD_GEN = "Generating world"
```
  </action>
  <verify>
Build: `dotnet build OniAccess/OniAccess.csproj -c Release` must succeed. Verify WorldGenHandler implements IAccessHandler and ITickable. Verify KeyPoller calls Tick on ITickable handlers. Verify ContextDetector maps both ClusterCategorySelectionScreen and ColonyDestinationSelectScreen to ColonySetupHandler.
  </verify>
  <done>
WorldGenHandler polls world generation progress and speaks at 25% intervals via ITickable. KeyPoller ticks the active handler each frame. ColonySetupHandler and WorldGenHandler are registered in ContextDetector for their screen types. World generation announces progress without user interaction required.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build OniAccess/OniAccess.csproj -c Release` -- clean build
2. ColonySetupHandler handles both ClusterCategorySelectionScreen and ColonyDestinationSelectScreen
3. ColonySetupHandler has Tab/Shift+Tab panel switching with 3 panels (only on ColonyDestinationSelectScreen)
4. Game mode entries speak name + description together
5. Cluster entries speak name + difficulty + world traits
6. Settings entries speak "label, value" with Left/Right cycling
7. WorldGenHandler implements ITickable and IAccessHandler (NOT BaseMenuHandler)
8. WorldGenHandler speaks progress at 25% intervals
9. KeyPoller calls Tick() on ITickable active handlers
10. All screen types registered in ContextDetector
</verification>

<success_criteria>
- User flow: Main Menu -> New Game -> Game Mode Select -> Asteroid Selection -> Settings Tab -> World Generation is fully navigable via keyboard with speech
- Game mode speaks name + description per decision
- Asteroid selection has Tab-switchable panels with full cluster info readout
- World generation progress is announced periodically without user input
- Project builds clean
</success_criteria>

<output>
After completion, create `.planning/phases/03-menu-navigation/03-03-SUMMARY.md`
</output>
